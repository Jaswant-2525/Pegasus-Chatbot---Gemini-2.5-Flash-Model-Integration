{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor - Ultimate UI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=Outfit:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'main/css/style.css' %}">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* Code Block Wrapper */
        .code-block-wrapper {
            margin: 10px 0;
            border-radius: 8px;
            overflow: hidden;
            background: #1e1e1e;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        /* Header with Language Name & Copy Button */
        .code-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #2d2d2d; padding: 6px 12px;
            color: #b0b0b0; font-size: 0.75rem; user-select: none;
        }
        /* The Code Area */
        pre { margin: 0; padding: 12px; overflow-x: auto; }
        code { font-size: 0.9rem; font-family: inherit; }
        
        /* Copy Button */
        .copy-btn {
            background: none; border: none; color: #fff; cursor: pointer;
            font-size: 0.75rem; display: flex; align-items: center; gap: 5px;
            opacity: 0.7; transition: opacity 0.2s;
        }
        .copy-btn:hover { opacity: 1; }

        /* Thinking Animation */
        .thinking-dots { animation: pulse 1.5s infinite; color: #666; font-style: italic; }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        /* ERROR FIX 3: Added Missing Dropdown Positioning Classes */
        .bottom-left-align {
            bottom: 100%;
            left: 0;
            margin-bottom: 10px;
        }
        .bottom-right-align {
            bottom: 100%;
            right: 0;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    {% csrf_token %}

    <aside class="sidebar">
        <div class="new-chat-btn" onclick="startNewChat()"><span>+</span> New Chat</div>
        
        <div class="recent-chats" id="recentChatsList">
            <div class="recent-label">History</div>
            
            {% for session in sessions %}
            <div class="chat-item" onclick="loadChat({{ session.id }})">
                {{ session.title }}
            </div>
            {% empty %}
            <div style="padding: 10px 15px; color: #666; font-size: 0.85rem; font-style: italic;">
                No recent chats
            </div>
            {% endfor %}
        </div>

        <div class="user-profile">
            <div class="avatar-circle gradient-avatar" style="width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;">
                {{ request.user.first_name|slice:":2"|default:"JR"|upper }}
            </div>
            
            <div style="flex-grow: 1;">
                <div style="font-weight: 600; font-size: 0.9rem;">{{ request.user.first_name|default:"User" }}</div>
                <div style="font-size: 0.75rem; color: #666;">Pro 1.5</div>
            </div>
            
            <div class="settings-icon" title="Logout" onclick="fetch('/api/logout/').then(() => window.location.href='/login/')" style="cursor: pointer;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <div class="brand">
                <div class="sparkle-box glass-brand-icon antigravity-float">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="url(#brandGrad)">
                        <defs>
                            <linearGradient id="brandGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#EC4899" />
                                <stop offset="100%" style="stop-color:#3B82F6" />
                            </linearGradient>
                        </defs>
                        <path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z" fill="url(#brandGrad)"></path>
                    </svg>
                </div>
                <span class="brand-text">PEGASUS</span>
            </div>
            
            <div class="profile-icon gradient-avatar" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                {{ request.user.first_name|slice:":2"|default:"JR"|upper }}
            </div>
        </header>

        <div class="chat-window" id="chatWindow">
            <div class="welcome-msg" id="welcomeMsg">
                <h1 class="antigravity-text">Ask Intentionally!</h1>
                <p>What would you like to create today?</p>
                
                <div class="glass-grid">
                    <div class="glass-card float-delay-1" onclick="sendMessage('Generate a visual layout for a mobile app')">
                        <div class="icon-box blue-grad">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                        </div>
                        <div>
                            <h4>Visual Layout</h4>
                            <p>Generate a UI layout for a mobile app</p>
                        </div>
                    </div>
                    <div class="glass-card float-delay-2" onclick="sendMessage('Deep research on renewable energy trends')">
                        <div class="icon-box green-grad">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                        </div>
                        <div>
                            <h4>Deep Research</h4>
                            <p>Research trends in renewable energy</p>
                        </div>
                    </div>
                    <div class="glass-card float-delay-3" onclick="sendMessage('Create a promotional video script')">
                        <div class="icon-box purple-grad">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                        </div>
                        <div>
                            <h4>Create Video</h4>
                            <p>Draft a promotional video script</p>
                        </div>
                    </div>
                    <div class="glass-card float-delay-4" onclick="sendMessage('Explore the concept of Quantum Computing')">
                        <div class="icon-box orange-grad">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        </div>
                        <div>
                            <h4>Explore Topic</h4>
                            <p>Explain the concept of Quantum Computing</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-wrapper">
            <div class="input-container">
                <div class="file-pill" id="filePill">
                    <span>ðŸ“„</span> <span id="fileName">file.pdf</span>
                    <span class="remove-file" onclick="clearFile()">âœ•</span>
                </div>

                <div class="input-row">
                    <textarea id="userInput" rows="1" placeholder="Type a message..." oninput="autoResize(this)"></textarea>
                </div>

                <div class="input-footer">
                    <div class="left-controls">
                        <div style="position:relative;">
                            <input type="file" id="fileInput" style="display: none;">
                            <button class="plus-btn antigravity-btn" onclick="toggleDropdown('addMenu')" title="Add">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
                            </button>
                            
                            <div class="dropdown-menu bottom-left-align" id="addMenu">
                                <div class="dropdown-item" onclick="document.getElementById('fileInput').click()">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2196F3" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Upload Files
                                </div>
                                <div class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#FFC107" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> Add from Drive
                                </div>
                                <div class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg> Google Photos
                                </div>
                                <div class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9C27B0" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg> Import Code
                                </div>
                                <div class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#FF5722" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg> Canvas
                                </div>
                            </div>
                        </div>

                        <div style="position:relative;">
                            <button class="tools-btn antigravity-btn" onclick="toggleDropdown('toolsMenu')">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                                Tools
                            </button>

                            <div class="dropdown-menu bottom-left-align" id="toolsMenu">
                                <div class="dropdown-item" onclick="useTool('Create Image')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#673AB7" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg> Create Images
                                </div>
                                <div class="dropdown-item" onclick="useTool('Create Video')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#E91E63" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg> Create Videos
                                </div>
                                <div class="dropdown-item" onclick="useTool('Visual Layout')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2196F3" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg> Visual Layout
                                </div>
                                <div class="dropdown-item" onclick="useTool('Deep Research')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#009688" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Deep Research
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="right-controls">
                        <div style="position:relative;">
                            <div class="model-trigger" onclick="toggleDropdown('modelDropdown')">
                                <span id="currentModel">Pro 1.5</span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                            <div class="dropdown-menu bottom-right-align" id="modelDropdown">
                                <div class="dropdown-item" onclick="setModel('Flash')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFC107" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg> Flash
                                </div>
                                <div class="dropdown-item" onclick="setModel('Pro 1.5')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4285F4" stroke-width="2"><path d="M12 2L15 9L22 9L16 14L19 21L12 17L5 21L8 14L2 9L9 9L12 2Z"></path></svg> Pro 1.5
                                </div>
                                <div class="dropdown-item" onclick="setModel('Ultra')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9C27B0" stroke-width="2"><path d="M6 3h12l4 6-10 13L2 9z"></path></svg> Ultra
                                </div>
                            </div>
                        </div>
                        
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="{% static 'main/js/script.js' %}"></script>
</body>
</html>